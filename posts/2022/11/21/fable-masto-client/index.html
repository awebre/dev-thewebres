<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Hi! I&#39;m Austin Webre, and this is my dev blog."><meta name="generator" content="Eleventy v1.0.2"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><title>Incognitum: Part 1</title><link rel="stylesheet" href="/site.css"></head><body class="font-sans leading-normal tracking-normal text-gray-900"><div class="m-20"><h3 class="text-lg font-semibold"><a class="text-teal-500 hover:text-teal-600 hover:underline" href="/">dev.thewebres.com</a></h3><article class="mt-4"><h1 class="text-3xl font-bold">Incognitum: Part 1</h1><div class="flex justify-between"><p class="text-sm italic text-gray-400">I&#39;ve decided to take on an additional side project: a Mastodon client written in Fable.</p><p class="text-sm text-gray-400">11/21/2022, 2:07:00 AM CST</p></div><hr class="mt-2 mb-8"><section><h3 class="text-lg font-bold">Why Incognitum?</h3><p>Due to some unforseen circumstances, I am unable to work on migrating my Mastodon instance to Le Potato, but I've still been thinking about Mastodon and the broader Activity Pub ecosystem. Couple that with a crippling guilt around abandoning an F# project I started a while back, and you have the impetus for my latest project: a Mastodon client written in F# using Fable (an F# -> Javascript transpiler).</p><br><p>So you know why I'm doing this, but why the name "Incognitum"? As it turns out, "Incognitum" was the term used to refer to Mastodons among Europian settlers who had first recorded finding remnants of them. Since this term does have some connection to the term Mastodon, but isn't one of the more obvious mammoth-related terms, it seemed like a good name.</p><br></section><section class="mt-8"><h3 class="text-lg font-bold">Getting Started with Fable</h3><p>The Fable ecosystem, like much of the F# ecosystem, feels a little scattered and unwieldy. The documentation for Fable seems to point in a couple of different places in terms of starting points of various types. After trying a couple of the suggested templates myself, I ended up going with a template using <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://zaid-ajaj.github.io/Feliz/">Feliz</a> - a Fable-based React wrapper. This was mostly so that I would have something familiar (React) to draw some knoweledge on as I dive into this new F# world.</p><p><br></p><p>Getting the template installed and set up took two quick commands:</p><pre><code class="text-white bg-black p-0.5">dotnet new -i Feliz.Template 
dotnet new feliz -n incognitum</code>
    </pre><p>The basic template has a couple of components, but only renders one (in Main.fs): <code class="text-white bg-black p-0.5">Components.HelloWorld</code>. The first thing I did was swap that component out with <code class="text-white bg-black p-0.5">Components.Router</code>. This "Router" component sets things up so that the "index" route ("http://localhost:8080/") renders the word "Index". But it also exposes two other routes "/#/hello" and "/#/counter" which render the "Hello World" component and a cannonical "Counter" component respectively.</p><br><p>Now maybe I should have just read more carefully, but it took me a while to realize that the "/#/" was critical to the way that Feliz does routing by default. Once I dug a little further, I realized there were some alternate options, but I decided to leave them that way for the time being.</p><aside class="text-sm italic text-gray-500">This would turn out to be a mistake.</aside></section><section class="mt-8"><h3 class="text-lg font-bold">Making Contact with the Fediverse</h3><p>With the basics all figured out, my next step was to figure out what would be my first point of contact with the Fediverse. It turns out that Mastodon is not unlike many other REST API's in that it expects you to first authenticate your application with it, before you can do literally anything else. This gives me a natural first step: <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://docs.joinmastodon.org/client/token/">adding an OAuth application.</a></p><p><br></p><p>Where Mastodon does differ from many other REST API's is that it does allow for an automated registration of your application with the API. This means that you don't have to get some client id/secret pair set up via some developer portal, but instead you can simply register your application using an HTTP request. Logically speaking, Incognitum will eventually need to keep a store of which Mastodon instances it is registered with and what it's credentials are for each. For now, I decided to see if I could simply register an application for each "session", or reall just register an application at all. ðŸ˜…</p><br><p>In order to kick this workflow off, I started by replacing the MainPage component with a very simple HTML form. Though it isn't <em>semantically</em> a form, it is composed of a label, an input, and a submit button, so we'll call it "close enough".<pre><code class="text-white bg-black p-0.5">dotnet new -i Feliz.Template 
dotnet new feliz -n incognitum</code>
    </pre></p><p>The basic template has a couple of components, but only renders one (in Main.fs): <code class="text-white bg-black p-0.5">Components.HelloWorld</code>. The first thing I did was swap that component out with <code class="text-white bg-black p-0.5">Components.Router</code>. This "Router" component sets things up so that the "index" route ("http://localhost:8080/") renders the word "Index". But it also exposes two other routes "/#/hello" and "/#/counter" which render the "Hello World" component and a cannonical "Counter" component respectively.</p><br><p>Now maybe I should have just read more carefully, but it took me a while to realize that the "/#/" was critical to the way that Feliz does routing by default. Once I dug a little further, I realized there were some alternate options, but I decided to leave them that way for the time being. Below is the code and what that looks like:</p><br><img src="/img/2022/11/21/fable-masto-figure-1.png" alt="F# code for the Main Page component"><br><img src="/img/2022/11/21/fable-masto-figure-2.png" alt="A simple HTML form with the label 'Instance', a text input, and a submit button"><br><p>With the form set up, it was time to wire up an HTTP request, per the Mastodon documentation. My first instinct was to use a utility I had used once before, FsHttp. After pulling in the package and getting a strange error, it dawned on me: this code ultimately compiles down to Javascript, so I can't use FsHttp (which I'm fairly sure uses .NET's HttpClient under the hood). After consulting the Fable docs again, it became evident that I would need to use Fable.Fetch or Thoth.Fetch (which wraps Fable.Fetch). This is where things went fairly off the rails...</p><br><p>I'll summarize here, mostly because re-living the neightmare that was getting a simple post request working would be detremental to my overall wellbeing. I started off using Thoth.Fetch, which combines Fable.Fetch with a nice API for JSON serialization/deserialization. The api was pleasant enough and everything was going well. Once I had everything wired up, I made a request and got a 422 status code back. Now, the 422 status code is an expected one, per Mastodon's documentation. However, it mentions that you should receive an error message along with that status code - DevTools showed no response, just the status code.</p><br><p>Given that I wasn't getting an error message at all, I thought I had broken something with the request that I made. Looking around, it <em>seemed</em> as thought Thoth.Fetch wasn't actually sending an JSON with the requests I was making. So I decied to abandon Thoth.Fetch in favor of using Fable.Fetch directly. <strong>Big mistake.</strong></p><br><p>I fought with the Fable.Fetch api for hours, eventually abandoned it, came back to the Thoth.Fetch implementation, noticed that JSON <em>was in fact being sent</em>, but that Mastodon was always returning 422. With no error message to point me at what was going wrong, I just decided to start tweaking properties on the request until suddenly, I got a 200 OK. In fact, I had gotten back a set of credentials that I could presumably use to start querying Mastodon's API further.</p><br><p>The culprit? I had attempted to use the Feliz routing system to pre-emptively generate what would eventually be a valid redirect url. If you recall, Feliz uses "hash-based" routing by default, so my redirect url looking something like "localhost:8080/#/oauth/redirect". The request that succeeded had a redirect url that looked like "https://test.thewebres.com," on a hunch, I decided to remove the "hash" from the generated URL and... success!</p><br><p>At this point, it was clear that I would need to change the routing mode for Feliz, so I followed the instructions laid out in the documentation. Meaning, I added the "router.pathMode" argument and swapped out some usages of various methods that were specific to the "hash-based" routing. Having swapped everything out, I noticed a new problem - I couldn't navigate directly to any of the other URLs anymore. Unfortunately, this sent me down another rabbit hole, that had a simple enough solution: <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://github.com/Zaid-Ajaj/Feliz.Router/issues/17">add "historyApiFallback: true" to your webpack devserver config.</a></p></section><section class="mt-8"><h3 class="text-lg font-bold">Wrapping Up</h3><p>With all of those shenanigans out of the way, I finally have the first small piece of my client working. Users can go to the page, type in the domain of their Mastodon instance, and the app will reach out to register itself and get back a set of credentials. Here's the code for the Main Page at this point:</p><p><br><img src="/img/2022/11/21/fable-masto-figure-3.png" alt="F# code for the Main Page component, with a working HTTP request"><br></p><p>The plan now, is to tackle two problems next: storing the credentials and pulling a user's account information, but that will have to wait until next time.</p></section></article><footer><div class="flex mt-16"><a class="mr-2" href="https://github.com/awebre"><svg class="h-12" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg> </a><a rel="me" href="https://social.thewebres.com/@austin"><svg class="h-12" viewBox="0 0 16 16"><path d="M 15.659 9.592 C 15.424 10.72 13.553 11.956 11.404 12.195 C 10.283 12.32 9.18 12.434 8.003 12.384 C 6.079 12.302 4.56 11.956 4.56 11.956 C 4.56 12.13 4.572 12.297 4.595 12.452 C 4.845 14.224 6.478 14.33 8.025 14.379 C 9.586 14.429 10.976 14.02 10.976 14.02 L 11.04 15.337 C 11.04 15.337 9.948 15.884 8.003 15.984 C 6.93 16.039 5.598 15.959 4.047 15.576 C 0.683 14.746 0.104 11.4 0.015 8.006 C -0.012 6.998 0.005 6.048 0.005 5.253 C 0.005 1.782 2.443 0.765 2.443 0.765 C 3.672 0.238 5.782 0.017 7.975 0 L 8.029 0 C 10.221 0.017 12.332 0.238 13.561 0.765 C 13.561 0.765 15.999 1.782 15.999 5.253 C 15.999 5.253 16.03 7.814 15.659 9.592 Z M 13.124 5.522 L 13.124 9.725 L 11.339 9.725 L 11.339 5.646 C 11.339 4.786 10.951 4.35 10.175 4.35 C 9.317 4.35 8.887 4.867 8.887 5.891 L 8.887 8.124 L 7.113 8.124 L 7.113 5.891 C 7.113 4.867 6.683 4.35 5.825 4.35 C 5.049 4.35 4.661 4.786 4.661 5.646 L 4.661 9.725 L 2.876 9.725 L 2.876 5.522 C 2.876 4.663 3.111 3.981 3.582 3.476 C 4.067 2.971 4.703 2.712 5.493 2.712 C 6.406 2.712 7.098 3.039 7.555 3.695 L 8 4.39 L 8.445 3.695 C 8.902 3.039 9.594 2.712 10.507 2.712 C 11.297 2.712 11.933 2.971 12.418 3.476 C 12.889 3.981 13.124 4.663 13.124 5.522 Z" style="stroke:none;stroke-miterlimit:10;fill-rule:evenodd;"/></svg></a></div></footer></div></body></html>