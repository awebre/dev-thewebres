<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Hi! I&#39;m Austin Webre, and this is my dev blog."><meta name="generator" content="Eleventy v1.0.2"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><title>Incognitum: Part 2</title><link rel="stylesheet" href="/site.css"></head><body class="font-sans leading-normal tracking-normal text-gray-900"><div class="m-20"><h3 class="text-lg font-semibold"><a class="text-teal-500 hover:text-teal-600 hover:underline" href="/">dev.thewebres.com</a></h3><article class="mt-4"><h1 class="text-3xl font-bold">Incognitum: Part 2</h1><div class="flex justify-between"><p class="text-sm italic text-gray-400">Deploying a Fable PWA using Azure Static Web Apps.</p><p class="text-sm text-gray-400">11/22/2022, 10:15:00 PM CST</p></div><hr class="mt-2 mb-8"><section><h3 class="text-lg font-bold">Previously...</h3><p>On the last episode of "Building Incognitum", I created a brand new Fable-based React application using Feliz. This app has a very basic form that attempts to solve one small piece of the Mastodon Client problem: initiating an authorization flow. If you read this previous article, you'll know that I promised to keep down that path. However, I lied.</p><br><p>Given the headache I had with getting this Fable-based application up and running, I decided that I'd like to take a break from the Mastodon API and writing more F# and do something a little more relaxing: set up automated deployments. Being relatively well versed in the world of DevOps, I should've known better, but it seemed like a good idea at the time. ü§∑‚Äç‚ôÇÔ∏è</p><br></section><section class="mt-8"><h3 class="text-lg font-bold">Deploying to Azure Static Web Apps</h3><p>If you've read the docs around Azure Static Web Apps, they promise a streamlined way to create websites from static content, such as HTML, CSS, and Javascript. I started with the process that it described <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://learn.microsoft.com/en-us/azure/static-web-apps/get-started-portal?tabs=vanilla-javascript&pivots=github#create-a-static-web-app">in the docs</a>, but quickly realized that something was up...</p><br><img src="/img/2022/11/22/figure 1.png"><br><p>Now this original error message seemed to suggest that there were issues with the dependencies as they were installed from the template, but everything seemed to work fine for me locally, so I totally ignored that and started frantically Googling. This brought me to a <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://dev.to/azure/creating-static-web-apps-with-f-and-fable-4nac">very helpful dev.to article</a> with some sample code. I updated my github actions to match this setup, and... still no luck.</p><br><p>At this point, I'm getting desperate, so I re-read the original error message and realize that there are some conflicting npm dependencies that need to be addressed. I updated webpack and slogged through some errors, but that only brought me to a new set of errors, related to Oryx (the tool used for deploying your Static Web App to Azure). Specifically, the error complained about not being able to find the "dotnet" command, which I found odd because there was nothing dotnet related to deploy - Fable compiles down to Javascript, right?</p><br><p>The frantic Googling continues... Eventually, I come across some information that makes it all click: there is apparently a property in "Azure/static-web-apps-deploy@v1" for "skip_api_build". As best I can tell, the "Azure/static-web-apps-deploy@v1" step attempts to detect which type of applications might be present. Inspecting the files present, it determines that there is dotnet code that is present and assumes that the "API" that is meant to back my Static Web App, uses dotnet (when in fact, there is no "API" or Azure Functions here, just a static web app).</p><br><p>The flow of the Oryx deployment ends up being: attempt to build the front end, attempt to build the "API", upload the resulting files to Azure. The problem with this is, I don't have an "API" to build and the front end has actually already been built (thanks to the changes I made following that dev.to article). Once I had informed Oryx that it could skip both of those things, deployment succeeded and we were in business. The result of all this work was <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://github.com/awebre/incognitum/tree/5301ff6bb9eea29f5582e3d575f2b4f87dfcbccd">this</a> (pay special attention to the <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://github.com/awebre/incognitum/blob/5301ff6bb9eea29f5582e3d575f2b4f87dfcbccd/.github/workflows/deloy.yml">deploy.yml</a>).</p><aside class="text-sm italic text-gray-500">Feel free to <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://github.com/awebre/incognitum/commits/master">check the git history</a> between 68e373dae3cb197859bd207dc4471b834832aa48 and 5301ff6bb9eea29f5582e3d575f2b4f87dfcbccd to familiarize yourself with my suffering.</aside><br><p>With the deployment complete, I was able to set up a custom domain and the site is now available at <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://incognitum.thewebres.com">https://incognitum.thewebres.com</a>.</p></section><section class="mt-8"><h3 class="text-lg font-bold">Making this a PWA</h3><p>Now, many people would have been happy with getting automated deployments via GitHub and Azure, but there was one other fundamental piece that I felt was missing from this not-yet-useful Mastodon Client: it isn't a Progressive Web App. PWA's are all the rage, and honestly, I'm hoping (somewhat foolishly) to replace the several mobile clients I've downloaded with this app as a PWA. Besides, it can't be that hard, right?</p><br><p>Right! <em>Well... sort of.</em></p><br><p>I was able to find a tutorial that walked through most of the steps needed to make any React app a PWA - <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://imranhsayed.medium.com/setup-pwa-workbox-webpack-plugin-for-react-application-workbox-window-precaching-caching-at-40f9289650e5">on Medium</a>. It took a bit of tweaking, but this is what I got to work:</p><ul class="list-disc list-inside"><li><a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://github.com/awebre/incognitum/blob/f1a17abafddc78565d680c58d64a2f61f14677c3/src/manifest.json">manifest.json</a>, <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://github.com/awebre/incognitum/blob/f1a17abafddc78565d680c58d64a2f61f14677c3/src/serviceWorkerRegistration.js">serviceWorkerRegistration.js</a> , and <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://github.com/awebre/incognitum/blob/f1a17abafddc78565d680c58d64a2f61f14677c3/src/src-sw.js">src-sw.js</a> all under ./src</li><li>Changes to the <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://github.com/awebre/incognitum/blob/f1a17abafddc78565d680c58d64a2f61f14677c3/webpack.config.js">webpack.config.js</a> to include the manifest.json in the output directory and to inject the service worker.</li><li>Improvements to the icon assets, including a new icon which was generated using <a href="https://huggingface.co/spaces/stabilityai/stable-diffusion">Stable Diffusion</a></li></ul><p></p><aside class="text-sm italic text-gray-500">For some helpful image manipulation tricks see <a class="text-teal-500 hover:text-teal-600 hover:underline" href="/posts/2022/11/22/creating-favicons/">this post</a>.</aside><br><p>The end result is a web app that you can install on your device! <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://incognitum.thewebres.com">Check it out!</a></p><img src="/img/2022/11/22/figure 2.png"></section></article><footer><div class="flex mt-16"><a class="mr-2" href="https://github.com/awebre"><svg class="h-12" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg> </a><a rel="me" href="https://poboy.social/@riverrat"><svg class="h-12" viewBox="0 0 16 16"><path d="M 15.659 9.592 C 15.424 10.72 13.553 11.956 11.404 12.195 C 10.283 12.32 9.18 12.434 8.003 12.384 C 6.079 12.302 4.56 11.956 4.56 11.956 C 4.56 12.13 4.572 12.297 4.595 12.452 C 4.845 14.224 6.478 14.33 8.025 14.379 C 9.586 14.429 10.976 14.02 10.976 14.02 L 11.04 15.337 C 11.04 15.337 9.948 15.884 8.003 15.984 C 6.93 16.039 5.598 15.959 4.047 15.576 C 0.683 14.746 0.104 11.4 0.015 8.006 C -0.012 6.998 0.005 6.048 0.005 5.253 C 0.005 1.782 2.443 0.765 2.443 0.765 C 3.672 0.238 5.782 0.017 7.975 0 L 8.029 0 C 10.221 0.017 12.332 0.238 13.561 0.765 C 13.561 0.765 15.999 1.782 15.999 5.253 C 15.999 5.253 16.03 7.814 15.659 9.592 Z M 13.124 5.522 L 13.124 9.725 L 11.339 9.725 L 11.339 5.646 C 11.339 4.786 10.951 4.35 10.175 4.35 C 9.317 4.35 8.887 4.867 8.887 5.891 L 8.887 8.124 L 7.113 8.124 L 7.113 5.891 C 7.113 4.867 6.683 4.35 5.825 4.35 C 5.049 4.35 4.661 4.786 4.661 5.646 L 4.661 9.725 L 2.876 9.725 L 2.876 5.522 C 2.876 4.663 3.111 3.981 3.582 3.476 C 4.067 2.971 4.703 2.712 5.493 2.712 C 6.406 2.712 7.098 3.039 7.555 3.695 L 8 4.39 L 8.445 3.695 C 8.902 3.039 9.594 2.712 10.507 2.712 C 11.297 2.712 11.933 2.971 12.418 3.476 C 12.889 3.981 13.124 4.663 13.124 5.522 Z" style="stroke:none;stroke-miterlimit:10;fill-rule:evenodd;"/></svg></a></div></footer></div></body></html>