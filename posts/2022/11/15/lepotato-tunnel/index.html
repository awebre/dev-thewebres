<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Hi! I&#39;m Austin Webre, and this is my dev blog."><meta name="generator" content="Eleventy v1.0.2"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><title>Tunneling to Le Potato with Cloudflare</title><link rel="stylesheet" href="/site.css"></head><body class="font-sans leading-normal tracking-normal text-gray-900"><div class="m-20"><h3 class="text-lg font-semibold"><a class="text-teal-500 hover:text-teal-600 hover:underline" href="/">dev.thewebres.com</a></h3><article class="mt-4"><h1 class="text-3xl font-bold">Tunneling to Le Potato with Cloudflare</h1><div class="flex justify-between"><p class="text-sm italic text-gray-400">Exposing a potato over the internet, with care.</p><p class="text-sm text-gray-400">11/15/2022, 10:45:00 PM CST</p></div><hr class="mt-2 mb-8"><section><h3 class="text-lg font-bold">I Promise This Is Not an Ad</h3><p>Being a developer, I know that exposing devices over the internet is always a risky business. Not being well versed in server administration, I have no clue how to securely expose a server on my home network to the internet at large. That's why I turned to <em>Cloudflare</em>, a trusted name in the realm of all things internet.</p><br><p>In truth, I had recently heard about an offering of there's that allowed you to create secure tunnels to a device, without directly exposing ports to the internet at large. Given that this is exaclty what I wanted (a secure, direct connection to my home server without making it available to the broader internet), this seemed like the perfect time to try it out.</p></section><section class="mt-8"><h3 class="text-lg font-bold">Getting Cloudflared</h3><aside class="mb-2 text-sm italic text-gray-500">Note: this guide assumes you have a Cloudflare account and at least one domain configured with Cloudflare.</aside><p>As it turns out, the process for starting up a Cloudflare Tunnel begins with installing a CLI tool, called Cloudflared. The tool is available for a wide range of operating systems and architectures, but for Le Potato, I downloaded the "cloduflared-linux-arm64.deb" package:</p><code class="text-white bg-black p-0.5">wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64.deb && dpkg -i cloudflared-linux-arm64.deb</code><br><br><p>With the Cloudflared CLI installed, it's time to login:</p><code class="text-white bg-black p-0.5">cloudflared tunnel login</code><br><br><p>The result of this command is some text letting you know that a browser window should have opened, prompting you to be logged in. But we're in terminal-only land, so that ain't gonna work. This prompt should also include the URL that the browser would have opened to (if it could have). You will need to copy this URL into a browser windo on any other device, and log in to your Cloudflare account.</p><br><p>Once you've successfully logged in and selected a domain, the Cloudflared command on Le Potato should complete, leaving behind a new directory ".cloudflared". In this directory are some keys that it will need later.</p><br><p>Now it's time to create our tunnel:</p><code class="text-white bg-black p-0.5">cloudflared tunnel create home</code><aside class="text-sm italic text-gray-500">Note: "home" is the name I decided to give my tunnel, you can call it anything you want.</aside><br><p>The result should be a file that will look like "home/ubuntu/.cloudflared/~GUID~.json". Make note of this GUID - you'll need it later. (Feel free to copy it to the clipboard, if you can find out how...)</p><br><p>Just to be sure that it worked, you can run:</p><code class="text-white bg-black p-0.5">cloudflared tunnel list</code><br><br><p>If all is well, you should see your tunnel's name in the list, along with some other information.</p><br><p>Lastly, you'll need to add a config file at "home/ubuntu/.cloudflared/config.yml" that looks like this:</p><pre><code class="text-white bg-black p-0.5">tunnel: ~your-tunnel-guid-from-earlier~
credentials-file: home/ubuntu/.cloudflared/~your-tunnel-guid-from-earlier~.json
        
ingress:
    - hostname: subdomain.yourdomain.net
      service: ssh://localhost:22
    - service: http_status:404</code></pre><br><br><p>This config exposes ssh over the Cloudflare tunnel and returns 404 for any requests to the tunnel that do not match that SSH port (22).</p></section><section class="mt-8"><h3 class="text-lg font-bold">Cloudflare for Teams</h3><p>The remaining part of this setup requires you to sign up for "Cloudflare for Teams". This part is a bit of a mess, so I would recommend stepping throug Step #3 of <a class="text-teal-500 hover:tex-teal-600 hover:underline" href="https://blog.cloudflare.com/ssh-raspberry-pi-400-cloudflare-tunnel-auditable-terminal/">this Cloudflare blog</a>, which covers it pretty well. The basic idea is that you'll sign up, then create an application, which will allow you to define rules around who can access the tunnel.</p><br><p>Once you've set up your application, it's time to hop back over to Le Potato and finish up the setup.</p><br><p>First you'll run:</p><p><code class="text-white bg-black p-0.5">cloudflared tunnel route dns ~your-guid~ subdomain.yourdomain.net</code></p><aside class="text-sm italic text-gray-500">This adds a CNAME record in cloudflare that will route back to the tunnel.</aside><br><p>Then you should be ready to run your tunnel:</p><code class="text-white bg-black p-0.5">cloudflared tunnel run your-tunnel-name-here</code><br><br><p>If all has gone according to plan, you should now be able to visit subdomain.yourdomain.net and see the Cloudflare Teams authentication flow. Once you get past that, you should be able to enter your username and password to gain access to an SSH session on the server!</p><br><aside class="text-sm italic text-gray-500">Want your tunnel to persist across reboots? <a class="text-teal-500 hover:text-teal-600 hover:underline" href="/posts/2022/11/16/cloudflared-service">Run Cloudflared as a Service</a></aside></section></article><footer><div class="flex mt-16"><a class="mr-2" href="https://github.com/awebre"><svg class="h-12" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg> </a><a rel="me" href="https://social.thewebres.com/@austin"><svg class="h-12" viewBox="0 0 16 16"><path d="M 15.659 9.592 C 15.424 10.72 13.553 11.956 11.404 12.195 C 10.283 12.32 9.18 12.434 8.003 12.384 C 6.079 12.302 4.56 11.956 4.56 11.956 C 4.56 12.13 4.572 12.297 4.595 12.452 C 4.845 14.224 6.478 14.33 8.025 14.379 C 9.586 14.429 10.976 14.02 10.976 14.02 L 11.04 15.337 C 11.04 15.337 9.948 15.884 8.003 15.984 C 6.93 16.039 5.598 15.959 4.047 15.576 C 0.683 14.746 0.104 11.4 0.015 8.006 C -0.012 6.998 0.005 6.048 0.005 5.253 C 0.005 1.782 2.443 0.765 2.443 0.765 C 3.672 0.238 5.782 0.017 7.975 0 L 8.029 0 C 10.221 0.017 12.332 0.238 13.561 0.765 C 13.561 0.765 15.999 1.782 15.999 5.253 C 15.999 5.253 16.03 7.814 15.659 9.592 Z M 13.124 5.522 L 13.124 9.725 L 11.339 9.725 L 11.339 5.646 C 11.339 4.786 10.951 4.35 10.175 4.35 C 9.317 4.35 8.887 4.867 8.887 5.891 L 8.887 8.124 L 7.113 8.124 L 7.113 5.891 C 7.113 4.867 6.683 4.35 5.825 4.35 C 5.049 4.35 4.661 4.786 4.661 5.646 L 4.661 9.725 L 2.876 9.725 L 2.876 5.522 C 2.876 4.663 3.111 3.981 3.582 3.476 C 4.067 2.971 4.703 2.712 5.493 2.712 C 6.406 2.712 7.098 3.039 7.555 3.695 L 8 4.39 L 8.445 3.695 C 8.902 3.039 9.594 2.712 10.507 2.712 C 11.297 2.712 11.933 2.971 12.418 3.476 C 12.889 3.981 13.124 4.663 13.124 5.522 Z" style="stroke:none;stroke-miterlimit:10;fill-rule:evenodd;"/></svg></a></div></footer></div></body></html>