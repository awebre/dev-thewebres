<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Hi! I&#39;m Austin Webre, and this is my dev blog."><meta name="generator" content="Eleventy v1.0.2"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><title>Automating Kasa Smart Plugs with Siri Shortcuts</title><link rel="stylesheet" href="/site.css"></head><body class="font-sans leading-normal tracking-normal text-gray-900"><div class="m-20"><h3 class="text-lg font-semibold"><a class="text-teal-500 hover:text-teal-600 hover:underline" href="/">dev.thewebres.com</a></h3><article class="mt-4"><h1 class="text-3xl font-bold">Automating Kasa Smart Plugs with Siri Shortcuts</h1><div class="flex justify-between"><p class="text-sm italic text-gray-400">Christmas time is here, which means it&#39;s time for high-tech light timers.</p><p class="text-sm text-gray-400">11/30/2022, 11:14:00 PM CST</p></div><hr class="mt-2 mb-8"><section><h3 class="text-lg font-bold">Christmas, Christmas Time is Here</h3><br><p>According to my wife, it is officially Christmas. Now, I'm not exactly one to get fully into the "Christmas spirit", but I do contribute to the holiday cheer with a little bit of home automation. This all started one fateful christmas season, when I got tired of unplugging the Christmas tree before going to bed. I could have bought a physical timer, like a normal person, but I had been listening to that year's "Shopping Spree" episode of <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://www.codingblocks.net/">Coding Blocks</a> and one of the hosts mentioned the Kasa smart plugs from TP-Link (his list can be found <a class="text-teal-500 hover:text-teal-600 hover:underline" href="https://www.codingblocks.net/podcast/the-2021-shopping-spree/#more-20074">here</a>).</p><br><p>I did a little bit of research and found out that the Kasa line of smart products had it's own app, but that this app integrated with Siri Shortcuts. That seemed like an ideal way for me to get into this whole "home automation" crazy. I had previously used Siri Shortcuts to send a text to my wife when I got in my car to go home, so I was familiar enough to feel like this would be a good fit.</p><br><p>And it largely was. That year, I set up a number of scenes in the Kasa app that were then accessible to be triggered via Shortcuts. Here was my set up:</p><ul class="list-disc list-inside"><li>When Wind Down Starts (at 9:30pm), trigger "lights out"</li><li>When I get out of the car (Carplay Disconnects) and am home, trigger "lights on"</li><li>When I get into the car (Carplay Connects) and am home, trigger "lights out"</li></ul><br><p>When the holiday season was over, I tucked away the smart plugs and didn't think twice about them. (Although I did end up buying some more of the outdoor variants to use for my power tool batteries).</p></section><section class="mt-8"><h3 class="text-lg font-bold">Home Automation Meets Bit Rot</h3><br><p>This year, when the Christmas tree came out again, I quickly reached for my trusty Kasa smart plug. I plugged it into the outlet and watched the lights blink orange and then blue as it remembered my home network and reconnected. Everything seemed to be going according to plan, except that I immediately noticed that my Shortcuts were no longer working. In fact, the Kasa shortcuts were all displaying a notification stating: "This action won't be supported in future versions of Kasa".</p><br><p>I did some quick Googling and found a variety of issues between Kasa and Shortcuts, but most people seemed to be able to resolve them through various combinations of removing/re-adding devices and scenes. None of these seemed to work for me. In fact, they made the problem worse as each time I removed a device or a scene, it was lost forever. Shortcuts did not seem to be aware of any of the new devices or scenes that were being added to Kasa. At this point, I turned to the official Kasa documentation and found another startling piece of information: their official documentation now recommends using IFTT to integrate with Shortcuts.</p><br><p>This was quite annoying to me. I'm familiar with IFTT (in fact, I probably have an ancient account floating around somewhere in the ether), but the whole point of this was that it was supposed to be simple, <em>right?</em> I suppose I was wrong in that assumption, but after fiddling with the IFTT integration for a bit, I got it working. So let's take a look at the easiest way to connect Kasa to Shortcuts (assuming you can't get their built in Shortcuts to work).</p></section><section class="mt-8"><h3 class="text-lg font-bold">Kasa > IFTT > Siri Shortcuts</h3><br><p>The first thing I did was get my scenes together in the Kasa app. In my case, I have a "Night" scene, which turns off the Christmas Tree as well as my power tool batteries (just in case I left them on).</p><br><img class="max-w-sm" src="/img/2022/11/30/fig_1.PNG" alt="A screenshot of a Kasa scene with an action to turn Christmas Tree off and an action to turn off the 'Batteries' group."><br><p>Next, I logged into the IFTT app (created an account as needed) and searched for "Kasa". I found an option like the one shown below:</p><br><img class="max-w-sm" src="/img/2022/11/30/fig_2.jpeg" alt="A screenshot of the IFTT app, with the search 'Kasa' entered and the TP-Link Kasa icon showing."><br><p>I clicked "Connect" which asked me to log in to my TP-Link Kasa account and authorized the connection between IFTT and Kasa. Once this was complete, I clicked "Create", which brought me into the IFTT Applet workflow. Step one is to add the "Button Widget" service and select "Button press" as the action, ending up with something like this:</p><br><img class="max-w-sm" src="/img/2022/11/30/fig_3.PNG" alt="A screenshot of the IFTT create Applet Workflow, with the 'IF' section filled with the button press widget."><aside class="text-sm italic text-gray-500">Note: you could also do this via the IFTT webhooks, which the official Kasa guides recommend, but using the button widget is much easier (trust me)</aside><br><p>Step 2 was to click "Add" next to "Then That" and search for "Kasa" again. Here I had several options to choose from, but I chose to go with "Activate scene," which brought me to a screen where I could select from the various scenes available. With my scene selected, I clicked "Create Action".</p><aside class="text-sm italic text-gray-500">Note: these scenes only seem to sync once, so when I eventually added additional scenes I had to "Reconnect" my Kasa account by going back to "Explore" in IFTT, searching "Kasa" again, and finding the "Reconnect" option (hidden behind a gear icon).</aside><br><p>The results looked something like this (this is the Edit version of the same workflow)</p><br><img class="max-w-sm" src="/img/2022/11/30/fig_4.jpg" alt="A screenshot of the IFTT app, with the search 'Kasa' entered and the TP-Link Kasa icon showing."><br><p>From here, I clicked "Continue", gave my Applet a title and I was done with IFTT!</p><br><p>With IFTT out of the way, it was time to create my shortcuts. I decided to go with "Home Automation" shortcuts, as those meant that any one could trigger them with their voice using our HomePod mini. The actual Shortcut is pretty straight forward, it is a single IFTT "Trigger Applet" Shortcut that triggers the "activate Night" IFTT widget button.</p><br><img class="max-w-sm" src="/img/2022/11/30/fig_5.png" alt="A screenshot of the Shortcut app with a single IFTT 'Trigger Applet' Shortcut with the 'activate Night' applet selected."><br><p>Once I had this set up, I was able to replace my existing Kasa Shortcuts in some of the Automations that I had previously had. For example, I was able to reuse the existing Shortcut that I had set up to run when Carplay Connects:</p><br><img class="max-w-sm" src="/img/2022/11/30/fig_6.jpg" alt="A screenshot of a Shortcut that compares the phone's current address to a static address and runs the 'Winding Down' shortcut if they match."><br><p>And that's how I got my Kasa smart plugs integrated again with all my favorite Shortcuts!</p></section></article><footer><div class="flex mt-16"><a class="mr-2" href="https://github.com/awebre"><svg class="h-12" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg> </a><a rel="me" href="https://poboy.social/@riverrat"><svg class="h-12" viewBox="0 0 16 16"><path d="M 15.659 9.592 C 15.424 10.72 13.553 11.956 11.404 12.195 C 10.283 12.32 9.18 12.434 8.003 12.384 C 6.079 12.302 4.56 11.956 4.56 11.956 C 4.56 12.13 4.572 12.297 4.595 12.452 C 4.845 14.224 6.478 14.33 8.025 14.379 C 9.586 14.429 10.976 14.02 10.976 14.02 L 11.04 15.337 C 11.04 15.337 9.948 15.884 8.003 15.984 C 6.93 16.039 5.598 15.959 4.047 15.576 C 0.683 14.746 0.104 11.4 0.015 8.006 C -0.012 6.998 0.005 6.048 0.005 5.253 C 0.005 1.782 2.443 0.765 2.443 0.765 C 3.672 0.238 5.782 0.017 7.975 0 L 8.029 0 C 10.221 0.017 12.332 0.238 13.561 0.765 C 13.561 0.765 15.999 1.782 15.999 5.253 C 15.999 5.253 16.03 7.814 15.659 9.592 Z M 13.124 5.522 L 13.124 9.725 L 11.339 9.725 L 11.339 5.646 C 11.339 4.786 10.951 4.35 10.175 4.35 C 9.317 4.35 8.887 4.867 8.887 5.891 L 8.887 8.124 L 7.113 8.124 L 7.113 5.891 C 7.113 4.867 6.683 4.35 5.825 4.35 C 5.049 4.35 4.661 4.786 4.661 5.646 L 4.661 9.725 L 2.876 9.725 L 2.876 5.522 C 2.876 4.663 3.111 3.981 3.582 3.476 C 4.067 2.971 4.703 2.712 5.493 2.712 C 6.406 2.712 7.098 3.039 7.555 3.695 L 8 4.39 L 8.445 3.695 C 8.902 3.039 9.594 2.712 10.507 2.712 C 11.297 2.712 11.933 2.971 12.418 3.476 C 12.889 3.981 13.124 4.663 13.124 5.522 Z" style="stroke:none;stroke-miterlimit:10;fill-rule:evenodd;"/></svg></a></div></footer></div></body></html>